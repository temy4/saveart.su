$(document).ready(function() {
        $(function(){
            $("[data-hide]").on("click", function(){
                $(this).closest("." + $(this).attr("data-hide")).hide();
            });
        });
        var develop_pages = 0;
        var control_develop_pages = true;
        var price = 0;
        var free_support = 0;

        var items = $('#orderTab').children();
        var current = 0;
        var prev = 0;

        var allown_fsize = 3;
        var allown_formats = [
          'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
          'application/msword',
          'application/pdf'
        ]

        var prices = {
          develop_feedback: 1500,
          develop_cms: 5000,
          develop_eshop: 7000,
          develop_design_template: 5000,
          develop_design_unique: 15000,
          develop_design_ready: 0,
          page: 500,
          base_price: 7000,
          free_develop_pages: 0
        };

        //$('#orderModal').modal('show');
        $('input[type=file]').bootstrapFileInput();
        $('#develop_pages').pillbox();

        $('#service_support').on('change', function () {
          if( $('#service_support').checkbox('isChecked') ){
            $('#support-panel').show();
          }
          else{
            $('#support-panel').hide();
          }
        });

        $('#develop_pages').on('added.fu.pillbox removed.fu.pillbox', function (item) {
          calculate();
        });

        $('#develop_select').on('changed.fu.selectlist', function (evt, data) {
          __select_develop(data.value);
          calculate();
        });

        $('#support_select').on('changed.fu.selectlist', function (evt, data) {
          $('.support-info').hide();
          $('#support-' + data.value).show();
          calculate();
        });

        $(".nav-pills li").on("click", function(e) {
          if ( $(this).hasClass("disabled") ) {
            e.preventDefault();
            return false;
          }
          else{
            prev = current;
            step = $(this).attr('step') - 1;

            if ( __validate( prev ) ){
              move_progress(step);
              current = step;
            }
            else{
              $('#orderTab li:eq(' + prev + ') a').tab('show');
            }
          }
        });
        
        $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
          if ( !__validate( prev ) ){
            e.preventDefault();
            $('#orderTab li:eq(' + prev + ') a').tab('show');
          }
          if( current + 1 >= items.length ){
            $('#wizard-next').text('Отправить заказ');
          }
          else{
            $('#wizard-next').text('Далее');
          }
          if( current - 1 >= 0 ){
            $('#wizard-prev').removeClass('hidden');
          }
          else{
            $('#wizard-prev').addClass('hidden');
          }
          move_progress(current);
        })

        var __validate = function( step ){

          var passed = true;
          $('div.form-col').removeClass('has-error');

          switch ( step ){
            case 0:
              if ( passed && $('#contact_person').val().length == 0 ){
                $('#contact_person').parents('div.form-col').addClass('has-error');
                $('#contact_person').popover('show');
                passed = false;
              }
              if ( passed && $('#contact_email').val().length == 0 && $('#contact_phone').val().length == 0 ){
                $('#contact_email').parents('div.form-col').addClass('has-error');
                $('#contact_phone').parents('div.form-col').addClass('has-error');
                $('#contact_phone').popover('show');
                passed = false;
              }
              break;
          }
          if ( !passed ){
            $('#orderTab li:eq(' + step + ') a').tab('show');
          }
          return passed;
        }

        var __select_develop = function ( srv ){
          // set values to default
          develop_pages = 0;
          support = 1;
          price = 0;
          $('#is-int').hide();
          $('.srv-data-r').radio('uncheck');
          $('.srv-data-c').checkbox('uncheck');

          switch ( srv ){
            case 0:
              $('#is-int').show();
              control_develop_pages = true;
              prices.free_develop_pages = 0;
              free_support = 0;
              break;
            case 1:
              free_support = 1;
              prices.free_develop_pages = 7;
              $('#develop_design-template').radio('check');
              $('#develop_feedback').checkbox('check');
              control_develop_pages = true;
              break;
            case 2:
              free_support = 1;
              prices.free_develop_pages = 7;
              $('#develop_design-unique').radio('check');
              $('#develop_feedback').checkbox('check');
              $('#develop_cms').checkbox('check');
              control_develop_pages = false;
              break;
            case 3:
              free_support = 2;
              prices.free_develop_pages = 43;
              $('#develop_design-unique').radio('check');
              $('#is-int').show();
              $('#develop_feedback').checkbox('check');
              $('#develop_cms').checkbox('check');
              $('#develop_eshop').checkbox('check');
              control_develop_pages = false;
              break;
          }
        }

        $('.sr-only').click(function(){
          calculate();
        })

        var move_progress = function ( pos ){
          var prc = (pos / (items.length - 1) ) * 100;
          $('#wizard-progress').css('width', prc + '%').attr('aria-valuenow', prc); 
        }

        var calculate = function ( ){
          develop_pages = $('#develop_pages').pillbox('itemCount');
          if ( $('#develop_select').selectlist('selectedItem').value == 0 ){
            price = prices.base_price;
          }
          else{
            price = 0;
          }

          price += $('#develop_design-template').radio('isChecked') ? prices.develop_design_template : 0;
          price += $('#develop_design-unique').radio('isChecked')   ? prices.develop_design_unique   : 0;

          price += $('#develop_feedback').checkbox('isChecked') ? prices.develop_feedback : 0;
          price += $('#develop_cms').checkbox('isChecked')      ? prices.develop_cms      : 0;
          price += $('#develop_eshop').checkbox('isChecked')    ? prices.develop_eshop    : 0;
          if ( control_develop_pages && develop_pages > prices.free_develop_pages ){
            price += (develop_pages * prices.page);
          }
          else{
            price += (prices.free_develop_pages * prices.page)
          }
          price = price < prices.base_price ? prices.base_price : price;

          if ( price > 0 ){
            $('#total_text').show();
          }
          else{
            $('#total_text').hide();
          }

          support = 0;
          if ( $('#service_support').checkbox('isChecked') && price > 0){
            switch ( $('#support_select').selectlist('selectedItem').value ){
              case 1:
                support = 5000;
                break;
              case 2:
                support = 7000;
                break;
              case 3:
                support = 10000;
                break;
              case 4:
                support = 20000;
                break;
            }
            $('#support_text p').html( 'поддержка:&nbsp;' + prettify(support) + '&nbsp;рублей в&nbsp;месяц, ' );
            if ( free_support > 0 ){
              $('#support_text p').append('<br />');
              $('#support_text p').append( numtostr(free_support, ['месяц', 'месяца', 'месяцев']) + ' бесплатно' );
            }
            $('#support_text').show();
          }
          else{
            $('#support_text').hide(); 
          }

          $('#total').html( prettify(price) );
        }

        var set_services = function ( id ){
          $('#develop_select').selectlist('selectByIndex', id);
          __select_develop( id );
        }

        var prettify = function( number ){
          number += '';
          x = number.split('&nbsp;');
          x1 = x[0];
          x2 = x.length > 1 ? '&nbsp;' + x[1] : '';
          var rgx = /(\d+)(\d{3})/;
          while (rgx.test(x1)) {
            x1 = x1.replace(rgx, '$1' + '&nbsp;' + '$2');
          }
          return x1 + x2;
        }

        numtostr = function ( number, titles )  {  
          cases = [2, 0, 1, 1, 1, 2];  
          return number + '&nbsp;' + titles[ (number%100>4 && number%100<20)? 2 : cases[(number%10<5)?number%10:5] ];  
        } 
        function __send_file(){
          var file = $('#company_file').prop('files')[0];

          if( file != undefined){
            var form_data = new FormData();

            form_data.append('file', file);

            $('#wizard-next').text('Шаг: 1/2 Загрузка файла');
            $.ajax({
              url: 'upload',
              dataType: 'text',
              cache: false,
              contentType: false,
              processData: false,
              data: form_data,                         
              type: 'POST',
              success: function(data){
                return true;
              },
              error: function(data){
                return false;
              }
            });
          }
          else{
            return true;
          }
        }
        
        function __send_info(){
          $('#wizard-next').title('Шаг: 2/2 Отправка заказа');

          var callDays = [];
          $('input[name=send_call_days]:checked').each(function() { callDays.push($(this).val()); })

          var request = $.ajax({
            url: "order",
            type: "POST",
            data: {
              // Contact data
              contact_company  : $('#contact_company').val(),
              contact_person   : $('#contact_person').val(),
              contact_phone    : $('#contact_phone').val(),
              contact_email    : $('#contact_email').val(),
              contact_country  : $('#contact_country').val(),
              contact_city     : $('#contact_city').val(),
              // Company additional info
              company_info     : $('#company_info').val(),
              company_file     : $('#contact_file').val(),
              // Shopping cart info
              develop_select   : $('#develop_select').selectlist('selectedItem'),
              develop_design   : $('input[name=develop_design]:checked').val(),
              develop_pages    : $('#develop_pages').pillbox('items'),
              develop_feedback : $('#develop_feedback').checkbox('isChecked') ? 1 : 0,
              develop_cms      : $('#develop_cms').checkbox('isChecked') ? 1 : 0,
              develop_eshop    : $('#develop_eshop').checkbox('isChecked') ? 1 : 0,
              develop_int_1c   : $('#develop_int_1c').checkbox('isChecked') ? 1 : 0,
              service_support  : $('#service_support').checkbox('isChecked') ? 1 : 0,
              support_select   : $('#support_select').selectlist('selectedItem'),
              // Send order
              send_call_hours  : $('#send_call_hours').selectlist('selectedItem'),
              send_call_days   : callDays,
              send_info        : $('#send_call_hours').val()
            },
            dataType: "html"
          });
           
          request.done(function( msg ) {
            $('#result-success').show();
          });
           
          request.fail(function( jqXHR, textStatus ) {
            $('#result-failure').show();
          });
          $('#wizard-next').button('reset');
        }

        function send_order () {
          $('.alert').hide();
          $('#wizard-next').button('loading');

          var send_ok = __send_file();

          if ( send_ok ){
            __send_info();
          }
          else{
            $('#result-failure').show();
            $('#wizard-next').button('reset');
          }
        }

        $('#wizard-next').on('click', function(){
          var res = __validate( current );
          if( res ){
            if( current + 1 <= items.length ){
              $('#orderTab li:eq(' + (current + 1) + ')').removeClass('disabled');
              $('#orderTab li:eq(' + (current + 1) + ') a').tab('show');
              current++;
            }
            if ( current >= items.length ){
              send_order();
            }
          }
        })

        $('#wizard-prev').on('click', function() {
          if( current - 1 >= 0 ){
            $('#orderTab li:eq(' + (current - 1) + ') a').tab('show');
            current--;
          }
        });
        $('#company_file').on('change', function() {
          var fsize = $(this)[0].files[0].size;
          var ftype = $(this)[0].files[0].type;

          $('#file-result-success').hide();
          $('#file-result-failure').hide();
          $(this).title('Выбрать другой файл');

          //$(this).loading();

          if( fsize > allown_fsize * 1048576 ) {
            h_size = Math.floor(fsize / 1048576);
            $('#file-result-failure #message').html('Слишком большой файл (' + numtostr(h_size, ['мегабайт', 'мегабайта', 'мегабайт']) + '). Попробуйте загрузить файл меньшего размера Максимальный разрешенный размер файла: ' + numtostr(allown_fsize, ['мегабайт', 'мегабайта', 'мегабайт']));
            $('#file-result-failure').show();
            $(this).reset();
            return false;
          }

          if ( allown_formats.indexOf(ftype) < 0 ){
            $('#file-result-failure #message').text('Некорректный формат файла. К загрузке разрешены только файлы типов DOC / DOCX (Microsoft Word) или PDF (Adobe Acrobat Reader)');
            $('#file-result-failure').show();
            $(this).reset();
            return false;
          }
        })
      })